{% extends 'kadima/base.html' %}
{% block content %}

      <div class="content">
        {% if ib_api_connected %}
            <div class="row sticky-top" id="indeces" style="background-color: #1e1d2e;" indeces_url="{% url 'indeces-data' %}">
            </div>
        {% else %}
          <div class="row sticky-top" id="indeces_delayed" style="background-color: #1e1d2e;">
              <div class="col-lg-2">
                <div class="card card-chart" style="background-color:{{ snp_color }};">
                  <div class="card-header">
                    <h1 class="card-title" style="color: aliceblue;">DOW</h1>
                    <h3 class="card-title"><i class="text-info"></i> {{ dow_value }} / {{ dow_change }}%</h3>
                  </div>
                </div>
              </div>
              <div class="col-lg-2">
                <div class="card card-chart" style="background-color:{{ snp_color }};">
                  <div class="card-header">
                    <h1 class="card-title" style="color: aliceblue;">S&P</h1>
                    <h3 class="card-title"><i class="text-info"></i> {{ snp_value }} / {{ snp_change }}%</h3>
                  </div>
                </div>
              </div>
              <div class="col-lg-2">
                <div class="card card-chart" style="background-color:{{ nas_color }};">
                  <div class="card-header">
                    <h1 class="card-title" style="color: aliceblue;">NASDAQ</h1>
                    <h3 class="card-title"><i class="text-success"></i> {{ nas_value }} / {{ nas_change }}%</h3>
                  </div>
                </div>
              </div>
              <div class="col-lg-2">
                <div class="card card-chart" style="background-color:{{ vix_color }};">
                  <div class="card-header">
                    <h1 class="card-title" style="color: aliceblue;">VIX</h1>
                    <h3 class="card-title"><i class="text-info"></i> {{ vix_value }} / {{ vix_change }}%</h3>
                  </div>
                </div>
              </div>
              <div class="col-lg-2">
                <div class="card card-chart" style="background-color:{{ r2k_color }};">
                  <div class="card-header">
                    <h1 class="card-title" style="color: aliceblue;">Russell 2K</h1>
                    <h3 class="card-title"><i class="text-info"></i> {{ r2k_value }} / {{ r2k_change }}%</h3>
                  </div>
                </div>
              </div>
            </div>
        {% endif %}
        
        <div class="row">
            <div class="col-md-5 pr-md-1">
                <form method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="row">
                      <div class="col-md-5 pr-md-1">
                        <div class="form-group">
                          <label style="color: aliceblue;">Enter stock to to add to the table</label>
                          <input type="text" class="form-control" name="stock" placeholder="Stock ticker, e.g. AAPL">
                        </div>
                      </div>
                      <div class="col-md-5 pr-md-1 mt-auto">
                        <button type="submit" name="add_stock" class="btn btn-fill btn-secondary bg-secondary">Add</button>
                      </div>
                    </div>
                </form>
            </div>
        </div>
        {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} display-message border " id="trigger_alerts">
              {{ message }}
            </div>
          {% endfor %}
        {% endif %}

        <div class="row">
          <div class="col-md-12">
            <form method="POST" enctype="multipart/form-data">
                {% csrf_token %}
            <div class="card  card-plain">
              <div class="row">
                <div class="col-6">
                  <div class="card-header">
                    <h4 class="card-title" id="table_index" value="{% url 'stock-data-api' table_index=table_index %}" >Stock Table {{ table_index }}</h4>
                    <p class="category"> Information about individual stocks</p>
                  </div>    
                </div>
                  <div class="col-6">
                    <h6>Change sapmling period. Current is {% if sample_period_14 %} 14 {% else %} 30 {% endif %} days.</h6>
                    <div>
                      <select name="sample_period" id="sample_period">
                        <option value="">------------</option>
                        {% if sample_period_14 %}
                          <option value="30">30 Days</option> 
                        {% else %}
                          <option value="14">14 Days</option>
                        {% endif %}
                      </select>
                      <button type="submit" name="update_sample_period" class="btn btn-fill btn-sm">Update</button>
                    </div>
                  </div>
              </div>
              <div class="card-body">
                {% if ib_api_connected %}
                  <div class="table-responsive" id="stocks_table">
                    <!-- API DATA -->
                  </div>
                {% else %}
                <div class="table-responsive" id="stocks_table_delayed">
                    <table id="example" class="table table-striped table-bordered" style="width:100%">
                      <thead class=" text-primary">
                        <tr>
                          <th>
                            <!-- <button type="submit" name="sort_by_date" class="text-primary"></button>   -->
                            Date
                          </th>
                          <th>
                            <!-- <button type="submit" name="sort_by_stock" class=" text-primary"></button>   -->
                            Symbol
                          </th>
                          <th class="text-center">
                            <!-- <button type="submit" name="sort_by_price" class=" text-primary"></button>   -->
                            Price
                          </th>
                          <th class="text-center">
                              Week 1
                          </th>
                          <th class="text-center">
                              Week 2
                          </th>
                          <th class="text-center">
                            <!-- <button type="submit" name="sort_by_week3" class=" text-primary"></button>   -->
                              Week 3
                          </th>
                          <th class="text-center">
                              Week 5
                          </th>
                          <th class="text-center">
                            <!-- <button type="submit" name="sort_by_gap1" class=" text-primary"></button>   -->
                              Gap 1
                          </th>
                          <th>
                            Earning  
                          </th>
                          <th>
                              MACD
                          </th>
                          <th>
                              MFI &nbsp;&nbsp;
                          </th>
                          <th>
                              Dividend Date
                          </th>
                          <th>
                              Dividend
                          </th>
                          <th>
                              Alarm
                          </th>   
                          <th>
                              Save
                          </th>   
                          <th>
                              Del
                         </th>   
                
                        </tr>
                      </thead>
                      <tbody>
                        {% for stock in stocks %}
                          {% if stock.week_3_color == 'green' and stock.gap_1_color == 'red' %}
                            <tr class="blink-row-buy">
                          {% elif stock.week_3_color == '#FF1000' and stock.gap_1_color == 'green' %}
                              <tr class="blink-row-sell">
                          {% else %}
                            <tr>
                          {% endif %}
                              <td  class="">
                                    {{ stock.stock_displayed_date }}
                                </td>
                                <td  class="">
                                    {{ stock.ticker }}
                                </td>
                                <td  class="">
                                    {{ stock.stock_price }}
                                </td>
                                <td  class="" style="background-color: {{ stock.week_1_color }}; ">
                                    {{ stock.week_1 }}%
                                </td>
                                <td  class="" style="border-right: 5px solid white; background-color: {{ stock.week_2_color }};">
                                    {{ stock.week_2 }}%
                                </td >
                                <td  class="" style="border-right: 5px solid white; background-color: {{ stock.week_3_color }}; ">
                                    {{ stock.week_3 }}%
                                </td>
                                <td  class="" style="border-right: 5px solid white; background-color: {{ stock.week_5_color }}; ">
                                    {{ stock.week_5 }}%
                                </td>
                                <td  class="" style="border-right: 5px solid white; background-color: {{ stock.gap_1_color }}; ">
                                <!-- <td  class="bg-success-light"> -->
                                    {{ stock.gap_1 }}%
                                </td>
                                <td class="{{ stock.earnings_warning }} " style="height: 100%;">
                                    {{ stock.earnings_call_displayed }}
                                </td>

                                {% if sample_period_14 %}
                                  <td  class=" border-right border-3" style="background-color: {{ stock.macd_14_color }}; text-align: center;">
                                      {% if stock.macd_14_clash %}
                                        <span>><</span>
                                      {% else %}
                                        <span>=</span>
                                      {% endif %}
                                  </td>
                                  {% else %}
                                  <td  class=" border-right border-3" style="background-color: {{ stock.macd_30_color }}; text-align: center;">
                                    {% if stock.macd_30_clash %}
                                      <span>><</span>
                                    {% else %}
                                      <span>=</span>
                                    {% endif %}
                                </td>
                                {% endif %}

                                {% if sample_period_14 %}
                                  <td  class="" style="background-color: {{ stock.mfi_14_color }}; text-align: center;">
                                    {% if stock.mfi_14_clash %}
                                      <span>><</span>
                                    {% else %}
                                      <span>=</span>
                                    {% endif %}
                                  </td>
                                {% else %}
                                  <td  class="" style="background-color: {{ stock.mfi_30_color }}; text-align: center;">
                                    {% if stock.mfi_30_clash %}
                                      <span>><</span>
                                    {% else %}
                                      <span>=</span>
                                    {% endif %}
                                  </td>
                                {% endif %}
                                <td class="" style="height: 100%;">
                                    {{ stock.dividend_date }}
                                </td>
                                <td class="" style="height: 100%;">
                                    ${{ stock.dividend }}
                                </td>
                                <td  class="">
                                  <button type="submit" value="{{ stock.id }}" name="alarm_stock" class="tim-icons icon-bell-55"></button>
                                </td>  
                                <td  class="">
                                    <button type="submit" value="{{ stock.id }}" name="save_stock" class="tim-icons icon-bullet-list-67"></button>
                                </td>
                                <td  class="">
                                    <button type="submit" value="{{ stock.id }}" name="delete_stock" class="tim-icons icon-trash-simple"></button>
                                </td>

                            </tr>

                        {% endfor %}
                      </tbody>
                    </table> 
                </div>
                {% endif %}
              </div>
            </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Source : https://bytutorial.com/blogs/css3/how-to-create-blinking-background-color-and-text-using-css3-animation -->
      <style>

        .kaka{
          border-style:solid;
           border-width: 5px;
          }

        
        .blink-update{
            color: #fff;
            animation: blinkingUpdate 2s infinite;
        }
        @keyframes blinkingUpdate{
            100%	{ background-color: #bd6116;}
        }


        .blink-bg{
            color: #fff;
            animation: blinkingBackground 2s infinite;
        }
        @keyframes blinkingBackground{
            100%	{ background-color: #04a1d5;}
        }

        .blink-row-buy{
          color: #fff;
          animation: blinkingRowBuy 4s infinite;
        }
        @keyframes blinkingRowBuy{
            100%	{ background-color: #068d2e;}
        }
        .blink-row-sell{
          color: #fff;
          animation: blinkingRowSell 4s infinite;
        }
        @keyframes blinkingRowSell{
            100%	{ background-color: #bb20a1;}
        }

        tr:hover{
          background-color: #79794f;
        }

        /*
        .blink_me {
          animation: blinker 1s linear infinite;
        }
        
        @keyframes blinker {  
          50% { opacity: 0; }
        }
        */

      </style>
      
      <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

      {% if ib_api_connected %}
        <script type="text/javascript">
                (function worker() {
                    let element = document.querySelector('#table_index');
                    let t_index_url = element.getAttribute('value');
                    console.log("Table Index URL: " + t_index_url)
                    $.ajax({
                    url: t_index_url,
                    success: function(response) {
                      //console.log(response);
                        $('#stocks_table').html(response);
                    }
                });		
                // Polling the API page every second
                setTimeout(worker, 2000);
            })();
            /*
            */
        </script>


        <script type="text/javascript">
          (function worker() {
              let indeces_element = document.getElementById('indeces')
              let indeces_url = indeces_element.getAttribute('indeces_url')
              $.ajax({
              url: indeces_url,
              success: function(response) {
             //     console.log(response);
                  $('#indeces').html(response);
              }
          });		
          // Polling the API page every second
          setTimeout(worker, 5000);
          })();
      /*
      */
        </script> 

    {% else %}
    <script>
      console.log('NOT CONNECTED TO API');
    </script>
      {% endif %}
 

{% endblock content %}
  